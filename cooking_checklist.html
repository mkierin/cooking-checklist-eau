<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooking Checklist</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .bucket-header {
            padding: 12px 15px;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }
        .bucket1-header {
            background-color: #4CAF50;
        }
        .bucket2-header {
            background-color: #9E9E9E;
            margin-top: 20px;
        }
        .bucket3-header {
            background-color: #673AB7;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        thead {
            background-color: #5c6bc0;
            color: white;
        }
        th {
            text-align: left;
            padding: 12px 15px;
            font-size: 16px;
        }
        td {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .dish-link {
            color: #0066cc;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
        }
        .dish-link:hover {
            text-decoration: underline;
        }
        .bucket1-row {
            background-color: #E8F5E9;
        }
        .bucket3-row {
            background-color: #EDE7F6;
        }
        .checkbox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        .header {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #5c6bc0;
            color: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
        }
        .hidden {
            display: none;
        }
        .portions {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        #refresh-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #refresh-button:hover {
            background-color: #45a049;
        }
        #loading-indicator {
            background-color: #ffeb3b;
            color: #333;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
    <style>
        /* Popup preview styles */
        #docs-popup {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 420px;
            height: 600px;
            background: #fff;
            border: 1px solid #bbb;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #docs-popup-header {
            background: #5c6bc0;
            color: #fff;
            font-weight: bold;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #docs-popup-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        #docs-popup-iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Google Docs Preview Popup -->
    <div id="docs-popup">
        <div id="docs-popup-header">
            <span id="docs-popup-title">Rezeptvorschau</span>
            <button id="docs-popup-close" title="Schließen">×</button>
        </div>
        <iframe id="docs-popup-iframe" allowfullscreen></iframe>
    </div>
    <div class="container">
        <div class="header">
            <h1>Eatunique Kochplan</h1>
            <button id="refresh-button" onclick="fetchDataFromGoogleSheets()">Aktualisieren</button>
        </div>
        <div id="loading-indicator" class="hidden">Daten werden geladen...</div>
        
        <table id="main-table">
            <thead>
                <tr>
                    <th>Gericht</th>
                    <th>Portionen</th>
                    <th colspan="2">Status</th>
                </tr>
            </thead>
            
            <!-- Bucket 1: First checkbox checked (Cooked) -->
            <tr class="bucket-header bucket1-header">
                <td colspan="4">Gekocht (Erste Checkbox)</td>
            </tr>
            <tbody id="bucket1-body">
                <!-- Rows will be added here -->
            </tbody>
            
            <!-- Bucket 2: Main bucket (no checkboxes checked) -->
            <tr class="bucket-header bucket2-header">
                <td colspan="4">Zu kochen (Keine Checkbox)</td>
            </tr>
            <tbody id="bucket2-body">
                <!-- Rows will be added here -->
            </tbody>
            
            <!-- Bucket 3: Both checkboxes checked -->
            <tr class="bucket-header bucket3-header">
                <td colspan="4">Fertig (Beide Checkboxen)</td>
            </tr>
            <tbody id="bucket3-body">
                <!-- Rows will be added here -->
            </tbody>
        </table>
    </div>
    
    <script>
        // Main data array to store all dish information
        let tableData = [];
        
        // Object to store original positions in main bucket
        const originalPositions = {};
        
        // Track positions in each bucket
        const bucket1Order = [];
        const bucket3Order = [];
        
        // Function to initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data from Google Sheets
            fetchDataFromGoogleSheets();
        });
        
        /**
         * Function to fetch and parse CSV data from Google Sheets
         * Uses a CORS proxy to handle cross-origin requests
         * Includes cache busting to ensure fresh data
         */
        function fetchDataFromGoogleSheets() {
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            // Original CSV URL from Google Sheets
            const originalCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlkqs1NPRzcnn5pL0idFo0u58eDZSExJarqh2NqQexmhSMLYmyahISVleD04TULNebkNoi92XFDVvM/pub?gid=1548051930&single=true&output=csv';
            
            // Use a CORS proxy to handle cross-origin requests
            const corsProxyUrl = 'https://corsproxy.io/?';
            
            // Add cache busting parameter to always fetch fresh data
            const csvUrl = corsProxyUrl + encodeURIComponent(originalCsvUrl + '&cachebust=' + Date.now());
            
            console.log('Fetching data from:', csvUrl);
            
            // Primary fetch attempt using CORS proxy
            fetch(csvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(csvText => {
                    processCsvData(csvText);
                    // Hide loading indicator on success
                    document.getElementById('loading-indicator').classList.add('hidden');
                })
                .catch(error => {
                    console.error('Error fetching or parsing CSV:', error);
                    console.log('Trying direct fetch as fallback...');
                    
                    // Fallback: try direct fetch (works in some environments)
                    fetch(originalCsvUrl, { mode: 'no-cors' })
                        .then(response => {
                            if (response.type === 'opaque') {
                                // With no-cors, we can't actually read the content
                                console.log('Direct fetch succeeded but content is opaque due to CORS');
                                throw new Error('Cannot read content due to CORS restrictions');
                            }
                            return response.text();
                        })
                        .then(csvText => {
                            console.log('Direct fetch succeeded!');
                            processCsvData(csvText);
                            // Hide loading indicator on success
                            document.getElementById('loading-indicator').classList.add('hidden');
                        })
                        .catch(directError => {
                            console.error('Direct fetch also failed:', directError);
                            console.log('Falling back to default empty data');
                            // Use sample data if all fetches fail
                            useSampleData();
                            // Hide loading indicator when using sample data
                            document.getElementById('loading-indicator').classList.add('hidden');
                        });
                });
        }
        
        // Function to use sample data for testing
        function useSampleData() {
            const sampleData = [
                ["Gemüserösti", 115, false, false, "https://docs.google.com/document/d/sample1"],
                ["Bärlauchkalbshackbraten", 132, false, false, "https://docs.google.com/document/d/sample2"],
                ["Gemüsesuppe", 42, false, false, "https://docs.google.com/document/d/sample4"],
                ["Hackbällchen mit Tomatensoße", 20, false, false, "https://docs.google.com/document/d/sample5"],
                ["Hackbraten an Jus", 83, false, false, "https://docs.google.com/document/d/sample6"]
            ];
            
            // Clear the tableData array and add sample data
            tableData.length = 0;
            sampleData.forEach(row => tableData.push(row));
            
            // Initialize the table with sample data
            initTable();
        }
        
        /**
         * Helper function to properly parse CSV rows (handles quoted values)
         * This ensures proper handling of commas within quoted strings
         */
        function parseCSVRow(row) {
            const result = [];
            let insideQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    result.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            
            // Add the last value
            result.push(currentValue);
            
            return result;
        }
        
        /**
         * Process CSV text into structured data for the table
         * Filters out dishes with zero portions
         * Extracts Google Docs links from column G
         */
        function processCsvData(csvText) {
            // Parse CSV to array format
            const rows = csvText.split('\n');
            const parsedData = [];
            
            // Process each row (skip header if present)
            for (let i = 0; i < rows.length; i++) {
                if (!rows[i].trim()) continue; // Skip empty rows
                
                // Parse the CSV row properly (handling quoted values)
                const values = parseCSVRow(rows[i]);
                
                // Skip header row or rows without proper data
                if (isNaN(parseInt(values[1])) && i === 0) continue;
                if (!values[0]) continue; // Skip rows without a dish name
                
                // Parse portions value
                const portions = parseInt(values[1] || '0', 10);
                if (portions === 0) continue; // Skip rows with 0 portions
                
                // Create row in the format: [name, portions, checked1, checked2, url]
                parsedData.push([
                    values[0].trim(),                // Name
                    portions,                        // Portions
                    false,                          // First checkbox (always start unchecked)
                    false,                          // Second checkbox (always start unchecked)
                    values[6] || '#'                // URL from column G (Google Docs link) or default to '#'
                ]);
            }
            
            console.log('Parsed data from CSV:', parsedData);
            
            // Replace the table data with the parsed data
            tableData.length = 0; // Clear the array
            parsedData.forEach(row => tableData.push(row)); // Add new data
            
            // Initialize the table with the new data
            initTable();
        }
        
        // Initialize the table with the data
        function initTable() {
            // Sort the data alphabetically by dish name
            tableData.sort((a, b) => {
                return a[0].localeCompare(b[0]);
            });
            
            // Store original positions
            tableData.forEach((row, index) => {
                const dishId = getDishId(row);
                originalPositions[dishId] = index;
            });
            
            // Refresh all buckets
            refreshAllBuckets();
        }
        
        // Refresh all buckets with current data
        function refreshAllBuckets() {
            // Clear all bucket bodies
            document.getElementById('bucket1-body').innerHTML = '';
            document.getElementById('bucket2-body').innerHTML = '';
            document.getElementById('bucket3-body').innerHTML = '';
            
            // Populate buckets based on checkbox states
            tableData.forEach((row, index) => {
                createTableRow(row, index);
            });
        }
        
        // Create a unique ID for each dish
        function getDishId(row) {
            return `${row[0]}-${row[1]}`;
        }
        
        // Create a table row for a dish and add it to the appropriate bucket
        function createTableRow(rowData, index) {
            const [dish, portions, cooked, portioned] = rowData;
            const row = document.createElement('tr');
            const dishId = getDishId(rowData);
            
            // Set row ID for later reference
            row.id = dishId;
            
            // Add dish name cell with hyperlink to Google Docs
            const dishCell = document.createElement('td');
            if (dish) {
                const dishLink = document.createElement('a');
                // TEST MODE: All dish links use the PDF preview link
                dishLink.href = 'https://drive.google.com/file/d/190N_DFz7tF8qNlBd3_ezAw_f7HgKo_wL/preview'; // revert to rowData[4] for production
                dishLink.textContent = dish;
                dishLink.className = 'dish-link';
                dishLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    openDocsPopup('https://drive.google.com/file/d/190N_DFz7tF8qNlBd3_ezAw_f7HgKo_wL/preview', dish);
                });
                dishCell.appendChild(dishLink);
            }
            row.appendChild(dishCell);
            
            // Add portions cell
            const portionsCell = document.createElement('td');
            portionsCell.textContent = portions;
            portionsCell.className = 'portions';
            row.appendChild(portionsCell);
            
            // Add checkbox column with both checkboxes side by side
            const checkboxCell = document.createElement('td');
            checkboxCell.className = 'checkbox-container';
            checkboxCell.colSpan = 2;
            
            // First checkbox
            const checkbox1 = document.createElement('input');
            checkbox1.type = 'checkbox';
            checkbox1.checked = cooked;
            checkbox1.addEventListener('change', function() {
                handleCheckbox1Change(dishId, this.checked);
            });
            
            // Second checkbox
            const checkbox2 = document.createElement('input');
            checkbox2.type = 'checkbox';
            checkbox2.checked = portioned;
            checkbox2.disabled = !cooked; // Disable if first checkbox is not checked
            checkbox2.addEventListener('change', function() {
                handleCheckbox2Change(dishId, this.checked);
            });
            
            // Add both checkboxes to the same cell
            checkboxCell.appendChild(checkbox1);
            checkboxCell.appendChild(checkbox2);
            row.appendChild(checkboxCell);
            
            // Add to appropriate bucket based on checkbox states
            if (portioned) {
                // Both checkboxes checked - Bucket 3
                row.className = 'bucket3-row';
                document.getElementById('bucket3-body').appendChild(row);
                if (!bucket3Order.includes(dishId)) {
                    bucket3Order.push(dishId); // Add to bucket 3 order if not already there
                }
            } else if (cooked) {
                // Only first checkbox checked - Bucket 1
                row.className = 'bucket1-row';
                document.getElementById('bucket1-body').appendChild(row);
                if (!bucket1Order.includes(dishId)) {
                    bucket1Order.push(dishId); // Add to bucket 1 order if not already there
                }
            } else {
                // No checkboxes checked - Bucket 2 (Main)
                document.getElementById('bucket2-body').appendChild(row);
            }
        }
        
        // Handle change of the first checkbox
        function handleCheckbox1Change(dishId, isChecked) {
            // Find the dish in the data array
            const dishIndex = tableData.findIndex(row => getDishId(row) === dishId);
            if (dishIndex === -1) return;
            
            // Update data
            tableData[dishIndex][2] = isChecked;
            
            // If unchecking the first checkbox, also uncheck the second
            if (!isChecked) {
                tableData[dishIndex][3] = false;
                
                // Remove from bucket orders
                const bucket1Index = bucket1Order.indexOf(dishId);
                if (bucket1Index !== -1) {
                    bucket1Order.splice(bucket1Index, 1);
                }
                
                const bucket3Index = bucket3Order.indexOf(dishId);
                if (bucket3Index !== -1) {
                    bucket3Order.splice(bucket3Index, 1);
                }
            } else {
                // Add to bucket 1 order if checking
                if (!bucket1Order.includes(dishId)) {
                    bucket1Order.push(dishId);
                }
            }
            
            // Refresh the table
            refreshAllBuckets();
        }
        
        // Handle change of the second checkbox
        function handleCheckbox2Change(dishId, isChecked) {
            // Find the dish in the data array
            const dishIndex = tableData.findIndex(row => getDishId(row) === dishId);
            if (dishIndex === -1) return;
            
            // Update data - second checkbox can only be checked if first is checked
            if (tableData[dishIndex][2]) {
                tableData[dishIndex][3] = isChecked;
                
                if (isChecked) {
                    // Move from bucket 1 to bucket 3
                    const bucket1Index = bucket1Order.indexOf(dishId);
                    if (bucket1Index !== -1) {
                        bucket1Order.splice(bucket1Index, 1);
                    }
                    
                    if (!bucket3Order.includes(dishId)) {
                        bucket3Order.push(dishId);
                    }
                } else {
                    // Move from bucket 3 to bucket 1
                    const bucket3Index = bucket3Order.indexOf(dishId);
                    if (bucket3Index !== -1) {
                        bucket3Order.splice(bucket3Index, 1);
                    }
                    
                    if (!bucket1Order.includes(dishId)) {
                        bucket1Order.push(dishId);
                    }
                }
            }
            
            // Refresh the table
            refreshAllBuckets();
        }
        
        // Reset position tracking
        function resetPositionTracking() {
            bucket1Order.length = 0;
            bucket3Order.length = 0;
            Object.keys(originalPositions).forEach(key => delete originalPositions[key]);
        }
        // Google Docs Popup logic
        function openDocsPopup(url, dishName) {
            // TEST MODE: Always show the same PDF from Google Drive for all dishes
            const popup = document.getElementById('docs-popup');
            const iframe = document.getElementById('docs-popup-iframe');
            const title = document.getElementById('docs-popup-title');
            // Use the working PDF preview link (update to dynamic later)
            iframe.src = "https://drive.google.com/file/d/190N_DFz7tF8qNlBd3_ezAw_f7HgKo_wL/preview";
            title.textContent = dishName || 'Rezeptvorschau';
            popup.style.display = 'flex';
        }
        document.getElementById('docs-popup-close').onclick = function() {
            document.getElementById('docs-popup').style.display = 'none';
            document.getElementById('docs-popup-iframe').src = '';
        };
    </script>
</body>
</html>